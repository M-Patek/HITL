<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Swarm - Ultimate Commander</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>

    <style>
        /* --- 移植自“迭代前”的深色主题变量  --- */
        :root {
            --bg-color: #1e1e1e;
            --panel-bg: #252526;
            --border-color: #333;
            --accent: #4caf50; /* 绿色点缀 */
            --highlight: #3b82f6; /* 蓝色选中 */
            --text-main: #ccc;
            --text-muted: #888;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', monospace, sans-serif;
            overflow: hidden; /* 防止全屏滚动 */
        }

        /* 自定义滚动条 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* 左侧日志选中态 */
        .log-item.active {
            background-color: #37373d;
            border-left: 3px solid var(--accent);
        }

        /* 画廊网格 [cite: 84] */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        /* 图片卡片效果 */
        .artifact-card {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s;
        }
        .artifact-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        /* 终端风格文本 */
        .terminal-text { font-family: 'Consolas', 'Monaco', monospace; }
        
        /* 闪烁光标 */
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div id="app" class="flex flex-col h-full">
        
        <header class="h-14 bg-[#2d2d2d] border-b border-[#333] flex items-center justify-between px-4 shrink-0">
            <div class="flex items-center gap-3">
                <h1 class="text-lg font-bold text-green-500"><i class="fas fa-robot"></i> Gemini Commander</h1>
                <span class="text-xs bg-[#444] px-2 py-0.5 rounded text-white">{{ currentPhase }}</span>
            </div>
            <div class="flex items-center gap-4 text-xs text-gray-400">
                <span>Task ID: {{ taskId }}</span>
                <div class="flex gap-1">
                    <span class="w-2 h-2 rounded-full bg-green-500" title="Plan"></span>
                    <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse" title="Execute"></span>
                    <span class="w-2 h-2 rounded-full bg-gray-600" title="Summary"></span>
                </div>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            
            <div class="w-1/3 bg-[#252526] border-r border-[#333] flex flex-col min-w-[300px]">
                <div class="p-3 border-b border-[#333] bg-[#2d2d2d]">
                    <h2 class="text-sm font-bold text-gray-300"><i class="fas fa-list-ul"></i> 主任务流 (Main Loop)</h2>
                </div>
                
                <div class="flex-1 overflow-y-auto p-2 space-y-2">
                    <div v-for="(log, index) in mainLogs" 
                         :key="index" 
                         @click="log.run_id ? selectRun(log.run_id) : null"
                         :class="['log-item p-3 rounded cursor-pointer transition-colors text-sm border border-transparent hover:bg-[#333]', 
                                  currentRunId === log.run_id ? 'active' : '',
                                  !log.run_id ? 'opacity-70 pointer-events-none' : '']">
                        
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-blue-400">{{ log.agent }}</span>
                            <span class="text-[10px] text-gray-500">{{ log.time }}</span>
                        </div>
                        <div class="text-gray-300">{{ log.message }}</div>
                        
                        <div v-if="log.run_id" class="mt-2 text-[10px] text-green-500 flex items-center gap-1">
                            <i class="fas fa-microchip"></i> 
                            <span>包含 {{ getSubLogCount(log.run_id) }} 条子记录 & {{ getArtifactCount(log.run_id) }} 个产出物</span>
                        </div>
                    </div>
                </div>

                <div class="p-4 border-t border-[#333] bg-[#1e1e1e]">
                    <label class="text-xs text-yellow-500 font-bold mb-1 block"><i class="fas fa-hand-sparkles"></i> 注入神谕 (HITL)</label>
                    <div class="flex gap-2">
                        <input v-model="userInput" 
                               @keyup.enter="sendIntervention"
                               placeholder="输入指令干预 Agent..." 
                               class="w-full bg-[#333] border border-[#444] rounded p-2 text-sm text-white focus:outline-none focus:border-green-500">
                        <button @click="sendIntervention" class="bg-green-600 hover:bg-green-700 text-white px-3 rounded">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex-1 flex flex-col bg-[#1e1e1e]">
                
                <div class="h-10 border-b border-[#333] bg-[#252526] flex items-center justify-between px-4">
                    <h2 class="text-sm text-gray-300">
                        <i class="fas fa-layer-group"></i> 
                        子任务详情: <span class="text-green-400 font-mono">{{ currentRunId || '等待选择...' }}</span>
                    </h2>
                    
                    <div class="flex bg-[#333] rounded p-0.5">
                        <button @click="viewMode = 'terminal'" 
                                :class="['px-3 py-1 text-xs rounded transition-all', viewMode === 'terminal' ? 'bg-[#444] text-white shadow' : 'text-gray-500 hover:text-gray-300']">
                            <i class="fas fa-terminal"></i> 终端
                        </button>
                        <button @click="viewMode = 'canvas'" 
                                :class="['px-3 py-1 text-xs rounded transition-all', viewMode === 'canvas' ? 'bg-[#444] text-white shadow' : 'text-gray-500 hover:text-gray-300']">
                            <i class="fas fa-image"></i> 画布
                        </button>
                    </div>
                </div>

                <div class="flex-1 overflow-hidden relative">
                    
                    <div v-if="viewMode === 'terminal'" class="h-full overflow-y-auto p-4 terminal-text">
                        <div v-if="!currentSubLogs.length" class="h-full flex flex-col items-center justify-center text-gray-600">
                            <i class="fas fa-arrow-left text-2xl mb-2"></i>
                            <p>请在左侧选择一个包含 run_id 的任务节点</p>
                        </div>
                        
                        <div v-for="(entry, idx) in currentSubLogs" :key="idx" class="mb-4 pl-4 border-l-2 border-green-800">
                            <div class="text-xs text-gray-500 mb-1">{{ entry.timestamp }}</div>
                            
                            <div v-if="entry.type === 'thought'" class="text-gray-400 italic">Thinking: {{ entry.content }}</div>
                            <div v-else-if="entry.type === 'info'" class="text-gray-300">{{ entry.content }}</div>
                            
                            <div v-else-if="entry.type === 'error'" class="text-red-400 bg-red-900/20 p-2 rounded border border-red-900">
                                <i class="fas fa-exclamation-triangle"></i> {{ entry.content }}
                            </div>

                            <div v-else-if="entry.type === 'code'" class="mt-2 text-xs">
                                <div class="bg-black/50 p-1 text-gray-500 rounded-t border border-[#444] border-b-0">Code Execution</div>
                                <pre class="bg-[#111] p-2 rounded-b border border-[#444] text-green-300 whitespace-pre-wrap font-mono">{{ entry.content }}</pre>
                            </div>
                        </div>
                        <div v-if="currentRunId" class="pl-4 text-green-500"><span class="blink">_</span></div>
                    </div>

                    <div v-if="viewMode === 'canvas'" class="h-full overflow-y-auto p-6 bg-[#1a1a1a]">
                        <div v-if="!currentArtifacts.length" class="h-full flex flex-col items-center justify-center text-gray-600">
                            <i class="fas fa-crop-alt text-2xl mb-2"></i>
                            <p>当前节点没有生成可视化的产出物 (Artifacts)</p>
                        </div>

                        <div class="gallery-grid">
                            <div v-for="(art, idx) in currentArtifacts" :key="idx" class="artifact-card flex flex-col">
                                <div class="p-2 border-b border-[#333] flex justify-between items-center bg-[#2d2d2d]">
                                    <span class="text-xs font-bold text-gray-300">
                                        <i :class="art.type === 'image' ? 'fas fa-image' : 'fas fa-code'"></i> {{ art.label }}
                                    </span>
                                    <button class="text-xs text-gray-500 hover:text-white"><i class="fas fa-download"></i></button>
                                </div>
                                
                                <div class="flex-1 bg-[#1e1e1e] flex items-center justify-center p-2 min-h-[200px]">
                                    <img v-if="art.type === 'image'" :src="art.content" class="max-w-full max-h-[300px] shadow-lg rounded" alt="Generated">
                                    
                                    <div v-else-if="art.type === 'code'" class="w-full h-full text-xs">
                                        <pre><code class="language-python">{{ art.content }}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, nextTick } = Vue;

        createApp({
            setup() {
                // --- 状态数据 ---
                const taskId = ref('task_phx_001');
                const currentPhase = ref('EXECUTION');
                const userInput = ref('');
                const viewMode = ref('terminal'); // terminal | canvas
                const currentRunId = ref(null);

                // --- 模拟数据: 主日志 (Macro) [cite: 13] ---
                const mainLogs = ref([
                    { agent: 'System', message: 'Phoenix Protocol Initialized.', time: '10:00:01', run_id: null },
                    { agent: 'Planner', message: 'Analyzing market data structure...', time: '10:00:05', run_id: 'run_plan_01' },
                    { agent: 'Coder', message: 'Generating Python visualization script.', time: '10:00:12', run_id: 'run_code_01' },
                    { agent: 'Reviewer', message: 'Validating output vs constraints.', time: '10:00:45', run_id: 'run_review_01' }
                ]);

                // --- 模拟数据: 子日志库 (Micro) [cite: 19] ---
                // 实际项目中应通过 API 获取
                const subLogDatabase = {
                    'run_plan_01': [
                        { type: 'thought', content: 'User wants a fractal tree. Need to determine recursive depth.', timestamp: '10:00:05' },
                        { type: 'info', content: 'Set depth = 10, angle = 30 degrees.', timestamp: '10:00:06' }
                    ],
                    'run_code_01': [
                        { type: 'thought', content: 'Importing matplotlib and numpy.', timestamp: '10:00:12' },
                        { type: 'code', content: 'import matplotlib.pyplot as plt\nimport numpy as np\n\ndef draw_tree(x, y):...', timestamp: '10:00:15' },
                        { type: 'info', content: 'Code executed successfully. Image buffer generated.', timestamp: '10:00:18' }
                    ],
                    'run_review_01': [
                        { type: 'thought', content: 'Checking for infinite loops...', timestamp: '10:00:45' },
                        { type: 'error', content: 'Warning: Recursion limit close to max.', timestamp: '10:00:46' },
                        { type: 'info', content: 'Optimization suggested.', timestamp: '10:00:48' }
                    ]
                };

                // --- 模拟数据: 产出物库 (Artifacts) [cite: 121] ---
                const artifactDatabase = {
                    'run_code_01': [
                        { type: 'code', label: 'fractal_tree.py', content: 'def tree(branchLen,t):\n    if branchLen > 5:\n        t.forward(branchLen)\n        t.right(20)\n        tree(branchLen-15,t)\n        t.left(40)\n        tree(branchLen-15,t)\n        t.right(20)\n        t.backward(branchLen)' },
                        // 使用占位符图片模拟
                        { type: 'image', label: 'preview_v1.png', content: 'https://placehold.co/600x400/222/green?text=Fractal+Tree+Preview' }
                    ]
                };

                // --- 计算属性 ---
                const currentSubLogs = computed(() => {
                    return currentRunId.value ? (subLogDatabase[currentRunId.value] || []) : [];
                });

                const currentArtifacts = computed(() => {
                    return currentRunId.value ? (artifactDatabase[currentRunId.value] || []) : [];
                });

                // --- 方法 ---
                const selectRun = (runId) => {
                    currentRunId.value = runId;
                    viewMode.value = 'terminal'; // 默认回终端看日志
                    // 重新高亮代码 [cite: 149]
                    nextTick(() => {
                        Prism.highlightAll();
                    });
                };

                const sendIntervention = () => {
                    if (!userInput.value) return;
                    // 模拟插入一条人工干预日志 [cite: 16]
                    mainLogs.value.push({
                        agent: 'Human (HITL)',
                        message: `Intervention: ${userInput.value}`,
                        time: new Date().toLocaleTimeString(),
                        run_id: null
                    });
                    userInput.value = '';
                    // 这里可以添加实际的 API 调用
                };

                const getSubLogCount = (runId) => (subLogDatabase[runId] || []).length;
                const getArtifactCount = (runId) => (artifactDatabase[runId] || []).length;

                return {
                    taskId, currentPhase, userInput, mainLogs, 
                    currentRunId, viewMode, currentSubLogs, currentArtifacts,
                    selectRun, sendIntervention, getSubLogCount, getArtifactCount
                };
            },
            mounted() {
                // 初始化 Prism
                Prism.highlightAll();
            }
        }).mount('#app');
    </script>
</body>
</html>
