<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Swarm - Ultimate Commander</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>

    <style>
        :root {
            --bg-color: #1e1e1e;
            --panel-bg: #252526;
            --border-color: #333;
            --accent: #4caf50; /* 绿色点缀 */
            --highlight: #3b82f6; /* 蓝色选中 */
            --text-main: #ccc;
            --text-muted: #888;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', monospace, sans-serif;
            overflow: hidden; /* 防止全屏滚动 */
        }

        /* 自定义滚动条 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* 左侧日志选中态 */
        .log-item.active {
            background-color: #37373d;
            border-left: 3px solid var(--accent);
        }

        /* 画廊网格 */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        /* 图片卡片效果 */
        .artifact-card {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s;
        }
        .artifact-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        /* 终端风格文本 */
        .terminal-text { font-family: 'Consolas', 'Monaco', monospace; }
        
        /* 闪烁光标 */
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div id="app" class="flex flex-col h-full">
        
        <!-- 启动遮罩层 -->
        <div v-if="!isTaskRunning && !isTaskFinished && mainLogs.length === 0" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
            <div class="bg-[#252526] p-6 rounded-lg border border-[#333] w-[500px] shadow-2xl">
                <h2 class="text-xl font-bold text-green-500 mb-4"><i class="fas fa-power-off"></i> Initialize System</h2>
                <textarea v-model="initialInput" class="w-full bg-[#1e1e1e] border border-[#444] text-white p-3 rounded mb-4 h-32 focus:border-green-500 outline-none" placeholder="输入您的初始任务描述... (e.g. 帮我写一个贪吃蛇游戏并分析复杂度)"></textarea>
                <button @click="startSystem" :disabled="!initialInput" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded font-bold disabled:opacity-50">
                    <i class="fas fa-play"></i> Start Mission
                </button>
            </div>
        </div>

        <header class="h-14 bg-[#2d2d2d] border-b border-[#333] flex items-center justify-between px-4 shrink-0">
            <div class="flex items-center gap-3">
                <h1 class="text-lg font-bold text-green-500"><i class="fas fa-robot"></i> Gemini Commander</h1>
                <span class="text-xs bg-[#444] px-2 py-0.5 rounded text-white">{{ currentPhase }}</span>
            </div>
            <div class="flex items-center gap-4 text-xs text-gray-400">
                <span>Task ID: {{ taskId }}</span>
                <div class="flex gap-1">
                    <span class="w-2 h-2 rounded-full bg-green-500" title="Plan"></span>
                    <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse" title="Execute"></span>
                    <span class="w-2 h-2 rounded-full bg-gray-600" title="Summary"></span>
                </div>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            
            <div class="w-1/3 bg-[#252526] border-r border-[#333] flex flex-col min-w-[300px]">
                <div class="p-3 border-b border-[#333] bg-[#2d2d2d]">
                    <h2 class="text-sm font-bold text-gray-300"><i class="fas fa-list-ul"></i> 主任务流 (Main Loop)</h2>
                </div>
                
                <div class="flex-1 overflow-y-auto p-2 space-y-2">
                    <div v-for="(log, index) in mainLogs" 
                         :key="index" 
                         @click="log.run_id ? selectRun(log.run_id) : null"
                         :class="['log-item p-3 rounded cursor-pointer transition-colors text-sm border border-transparent hover:bg-[#333]', 
                                  currentRunId === log.run_id ? 'active' : '',
                                  !log.run_id ? 'opacity-70 pointer-events-none' : '']">
                        
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-blue-400">{{ log.agent }}</span>
                            <span class="text-[10px] text-gray-500">{{ log.time }}</span>
                        </div>
                        <div class="text-gray-300">{{ log.message }}</div>
                        
                        <div v-if="log.run_id" class="mt-2 text-[10px] text-green-500 flex items-center gap-1">
                            <i class="fas fa-microchip"></i> 
                            <span>包含 {{ getSubLogCount(log.run_id) }} 条子记录 & {{ getArtifactCount(log.run_id) }} 个产出物</span>
                        </div>
                    </div>
                </div>

                <div class="p-4 border-t border-[#333] bg-[#1e1e1e]">
                    <label class="text-xs text-yellow-500 font-bold mb-1 block"><i class="fas fa-hand-sparkles"></i> 注入神谕 (HITL)</label>
                    <div class="flex gap-2">
                        <input v-model="userInput" 
                               @keyup.enter="sendIntervention"
                               placeholder="输入指令干预 Agent..." 
                               class="w-full bg-[#333] border border-[#444] rounded p-2 text-sm text-white focus:outline-none focus:border-green-500">
                        <button @click="sendIntervention" class="bg-green-600 hover:bg-green-700 text-white px-3 rounded">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex-1 flex flex-col bg-[#1e1e1e]">
                
                <div class="h-10 border-b border-[#333] bg-[#252526] flex items-center justify-between px-4">
                    <h2 class="text-sm text-gray-300">
                        <i class="fas fa-layer-group"></i> 
                        子任务详情: <span class="text-green-400 font-mono">{{ currentRunId || '等待选择...' }}</span>
                    </h2>
                    
                    <div class="flex bg-[#333] rounded p-0.5">
                        <button @click="viewMode = 'terminal'" 
                                :class="['px-3 py-1 text-xs rounded transition-all', viewMode === 'terminal' ? 'bg-[#444] text-white shadow' : 'text-gray-500 hover:text-gray-300']">
                            <i class="fas fa-terminal"></i> 终端
                        </button>
                        <button @click="viewMode = 'canvas'" 
                                :class="['px-3 py-1 text-xs rounded transition-all', viewMode === 'canvas' ? 'bg-[#444] text-white shadow' : 'text-gray-500 hover:text-gray-300']">
                            <i class="fas fa-image"></i> 画布
                        </button>
                    </div>
                </div>

                <div class="flex-1 overflow-hidden relative">
                    
                    <div v-if="viewMode === 'terminal'" class="h-full overflow-y-auto p-4 terminal-text">
                        <div v-if="!currentSubLogs.length" class="h-full flex flex-col items-center justify-center text-gray-600">
                            <i class="fas fa-arrow-left text-2xl mb-2"></i>
                            <p>请在左侧选择一个包含 run_id 的任务节点</p>
                        </div>
                        
                        <div v-for="(entry, idx) in currentSubLogs" :key="idx" class="mb-4 pl-4 border-l-2 border-green-800">
                            <!-- 这里展示 mock 或真实微观日志，暂时 API 没推微观日志，预留位置 -->
                            <div class="text-xs text-gray-500 mb-1">{{ entry.timestamp }}</div>
                        </div>
                        <div v-if="currentRunId" class="pl-4 text-green-500"><span class="blink">_</span></div>
                    </div>

                    <div v-if="viewMode === 'canvas'" class="h-full overflow-y-auto p-6 bg-[#1a1a1a]">
                        <div v-if="!currentArtifacts.length" class="h-full flex flex-col items-center justify-center text-gray-600">
                            <i class="fas fa-crop-alt text-2xl mb-2"></i>
                            <p>当前节点没有生成可视化的产出物 (Artifacts)</p>
                        </div>

                        <div class="gallery-grid">
                            <div v-for="(art, idx) in currentArtifacts" :key="idx" class="artifact-card flex flex-col">
                                <div class="p-2 border-b border-[#333] flex justify-between items-center bg-[#2d2d2d]">
                                    <span class="text-xs font-bold text-gray-300">
                                        <i :class="art.type === 'image' ? 'fas fa-image' : 'fas fa-code'"></i> {{ art.label }}
                                    </span>
                                    <button class="text-xs text-gray-500 hover:text-white"><i class="fas fa-download"></i></button>
                                </div>
                                
                                <div class="flex-1 bg-[#1e1e1e] flex items-center justify-center p-2 min-h-[200px]">
                                    <img v-if="art.type === 'image'" :src="art.content" class="max-w-full max-h-[300px] shadow-lg rounded" alt="Generated">
                                    
                                    <div v-else-if="art.type === 'code'" class="w-full h-full text-xs">
                                        <pre><code class="language-python">{{ art.content }}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, nextTick, reactive } = Vue;

        createApp({
            setup() {
                // --- 状态数据 ---
                const taskId = ref('Waiting...');
                const currentPhase = ref('IDLE');
                const userInput = ref('');
                const initialInput = ref('');
                const viewMode = ref('terminal'); // terminal | canvas
                const currentRunId = ref(null);
                
                const isTaskRunning = ref(false);
                const isTaskFinished = ref(false);

                // 动态日志数据
                const mainLogs = ref([]);
                
                // 数据仓库 (按 run_id 索引)
                const subLogDatabase = reactive({});
                const artifactDatabase = reactive({});

                // --- API 配置 ---
                const API_BASE = window.location.origin; // 自动获取当前源

                // --- 核心方法: 启动系统 ---
                const startSystem = async () => {
                    if (!initialInput.value) return;
                    
                    try {
                        // 1. 调用 Start Task API
                        isTaskRunning.value = true;
                        const res = await fetch(`${API_BASE}/api/start_task`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user_input: initialInput.value })
                        });
                        
                        if (!res.ok) throw new Error('Failed to start task');
                        const data = await res.json();
                        
                        taskId.value = data.task_id;
                        currentPhase.value = 'PLANNING';
                        
                        // 2. 建立 SSE 连接
                        connectEventStream(data.task_id);
                        
                    } catch (e) {
                        alert('Error: ' + e.message);
                        isTaskRunning.value = false;
                    }
                };

                // --- 核心方法: SSE 流处理 ---
                const connectEventStream = (tid) => {
                    const evtSource = new EventSource(`${API_BASE}/api/stream/${tid}`);
                    
                    evtSource.onmessage = (event) => {
                        // 心跳或无效数据
                        if (!event.data || event.data === 'end') return;
                    };

                    // 1. 宏观日志 (Macro Log) -> 左侧列表
                    evtSource.addEventListener("macro_log", (event) => {
                        const data = JSON.parse(event.data);
                        mainLogs.value.push({
                            agent: data.agent,
                            message: data.message,
                            run_id: data.run_id,
                            time: new Date().toLocaleTimeString()
                        });
                        // 自动滚动到底部
                        scrollToBottom();
                        
                        // 如果有 run_id，自动选中它以便查看详情
                        if (data.run_id) {
                            if (!subLogDatabase[data.run_id]) subLogDatabase[data.run_id] = [];
                            currentRunId.value = data.run_id;
                        }
                    });

                    // 2. 产出物 (Artifacts) -> 画布/代码
                    evtSource.addEventListener("artifact", (event) => {
                        const data = JSON.parse(event.data);
                        // 关联到当前最新的 run_id (如果没有 run_id，则关联到全局 'root')
                        const targetRunId = currentRunId.value || 'root';
                        
                        if (!artifactDatabase[targetRunId]) artifactDatabase[targetRunId] = [];
                        
                        // 避免重复添加 (简单去重)
                        const exists = artifactDatabase[targetRunId].some(a => a.label === data.label);
                        if (!exists) {
                            artifactDatabase[targetRunId].push({
                                type: data.type, // 'image' or 'code'
                                label: data.label,
                                content: data.content // Base64 or Text
                            });
                        }
                    });

                    // 3. 错误处理
                    evtSource.addEventListener("error", (event) => {
                        // SSE 的 error 事件 data 通常为空，或者是网络错误
                        if (event.data) {
                            console.error("Stream Error:", event.data);
                            mainLogs.value.push({
                                agent: 'System', message: `Error: ${event.data}`, time: new Date().toLocaleTimeString()
                            });
                        }
                        // 如果是 finish 事件 (自定义)
                        if (event.type === 'finish') {
                            evtSource.close();
                            isTaskRunning.value = false;
                            isTaskFinished.value = true;
                            currentPhase.value = 'COMPLETED';
                        }
                    });
                    
                    // 自定义结束事件
                    evtSource.addEventListener("finish", () => {
                        console.log("Stream finished.");
                        evtSource.close();
                        isTaskRunning.value = false;
                        isTaskFinished.value = true;
                        currentPhase.value = 'DONE';
                    });
                };

                // --- 核心方法: 人工干预 ---
                const sendIntervention = async () => {
                    if (!userInput.value || !taskId.value) return;
                    
                    const cmd = userInput.value;
                    userInput.value = ''; // 清空输入框
                    
                    // 乐观更新 UI
                    mainLogs.value.push({
                        agent: 'Human (HITL)',
                        message: `Intervention: ${cmd}`,
                        time: new Date().toLocaleTimeString(),
                        run_id: null
                    });

                    try {
                        await fetch(`${API_BASE}/api/intervention`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                task_id: taskId.value,
                                command: cmd 
                            })
                        });
                    } catch (e) {
                        mainLogs.value.push({ agent: 'System', message: 'Intervention Failed: ' + e.message });
                    }
                };

                // --- 辅助逻辑 ---
                const selectRun = (runId) => {
                    currentRunId.value = runId;
                    viewMode.value = 'terminal';
                    nextTick(() => Prism.highlightAll());
                };

                const scrollToBottom = () => {
                    // 简单实现：找到列表容器滚动 (需配合 DOM 结构，这里仅示意)
                    const el = document.querySelector('.log-item:last-child');
                    if (el) el.scrollIntoView({ behavior: 'smooth' });
                };

                // 计算属性
                const currentSubLogs = computed(() => currentRunId.value ? (subLogDatabase[currentRunId.value] || []) : []);
                const currentArtifacts = computed(() => currentRunId.value ? (artifactDatabase[currentRunId.value] || []) : []);
                const getSubLogCount = (runId) => (subLogDatabase[runId] || []).length;
                const getArtifactCount = (runId) => (artifactDatabase[runId] || []).length;

                return {
                    taskId, currentPhase, userInput, initialInput, mainLogs, 
                    currentRunId, viewMode, currentSubLogs, currentArtifacts,
                    isTaskRunning, isTaskFinished,
                    startSystem, selectRun, sendIntervention, getSubLogCount, getArtifactCount
                };
            },
            mounted() {
                Prism.highlightAll();
            }
        }).mount('#app');
    </script>
</body>
</html>
