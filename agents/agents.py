from typing import List, Optional, Dict, Any, TypedDict
from core.rotator import GeminiKeyRotator
from core.models import ProjectState, ExecutionPlan, ExecutionStep, BaseModel
from tools.memory import VectorMemoryTool
from tools.search import GoogleSearchTool

# LangGraph State éœ€è¦
class AgentGraphState(TypedDict):
    project_state: ProjectState

# ... (OrchestratorAgent, ResearcherAgent, AnalystAgent ä»£ç ä¿æŒä¸å˜) ...
# è¯·ä¿ç•™åŸæœ‰çš„å…¶ä»– Agent ç±»

# =======================================================
# 4. CodingCrewAgent (å­å›¢é˜Ÿå°è£…) - NEW!
# =======================================================

class CodingCrewAgent:
    """
    [åˆ†å±‚æ¶æ„èŠ‚ç‚¹]
    è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ Agentï¼Œå®ƒå†…éƒ¨å°è£…äº†ä¸€ä¸ª CrewAI æˆ– AutoGen çš„å­å›¢é˜Ÿã€‚
    å®ƒä½œä¸ºä¸€ä¸ªå•ä¸€èŠ‚ç‚¹åµŒå…¥ LangGraphï¼Œè´Ÿè´£å¤„ç†å¤æ‚çš„ç¼–ç¨‹ã€é‡æ„å’Œå®¡æŸ¥é—­ç¯ä»»åŠ¡ã€‚
    """
    def __init__(self, rotator: GeminiKeyRotator):
        self.rotator = rotator
        # åœ¨è¿™é‡Œï¼Œå®é™…é¡¹ç›®ä¸­ä½ å¯ä»¥åˆå§‹åŒ– CrewAI çš„ Agents
        # from crewai import Agent, Task, Crew
        # self.coder = Agent(role='Senior Coder', goal='Write code', ...)
        # self.reviewer = Agent(role='Code Reviewer', goal='Review code', ...)

    def run(self, state: AgentGraphState) -> AgentGraphState:
        current_state = state["project_state"]
        
        if not current_state.execution_plan: return state
            
        # è·å–æŒ‡ä»¤ï¼Œè¿™é€šå¸¸æ˜¯ä¸€ä¸ªå¤æ‚çš„ç¼–ç¨‹ä»»åŠ¡
        current_instruction = current_state.execution_plan[0]['instruction']
        print(f"\nğŸ› ï¸ CodingCrewAgent (å­å›¢é˜Ÿ) å¯åŠ¨... (ä»»åŠ¡: {current_instruction[:50]}...)")
        print("ğŸ‘¥ æ­£åœ¨å¬é›†å†…éƒ¨ Crew (Coder & Reviewer)...")

        # =======================================================
        # è¿™é‡Œæ˜¯ CrewAI / AutoGen çš„å†…éƒ¨è¿è¡Œé€»è¾‘ (æ¨¡æ‹Ÿ)
        # =======================================================
        # å®é™…ä»£ç ç¤ºä¾‹:
        # task = Task(description=current_instruction, agent=self.coder)
        # crew = Crew(agents=[self.coder, self.reviewer], tasks=[task])
        # result = crew.kickoff()
        
        # æ¨¡æ‹Ÿ CrewAI çš„è¾“å‡º
        simulated_code_output = f"""
# --- Generated by CrewAI Sub-team ---
# Task: {current_instruction}
# Status: Reviewed & Approved

def mission_critical_function():
    print("This code was generated by a specialized sub-team.")
    return True
"""
        
        # å°†ç»“æœå­˜å…¥ Shared State
        current_state.code_blocks["crew_output"] = simulated_code_output
        
        # ä¹Ÿå¯ä»¥é€‰æ‹©æ›´æ–° final_report æˆ–è€…è¿½åŠ åˆ° chat history
        report_update = f"Coding Crew å·²å®Œæˆä»»åŠ¡ã€‚ç”Ÿæˆçš„ä»£ç å·²é€šè¿‡å†…éƒ¨å®¡æŸ¥ã€‚\nä»£ç é¢„è§ˆ:\n{simulated_code_output}"
        current_state.full_chat_history.append({"role": "model", "parts": [{"text": report_update}]})
        
        print("âœ… CodingCrewAgent å­å›¢é˜Ÿä»»åŠ¡å®Œæˆï¼ç»“æœå·²åˆå¹¶ã€‚")

        # ç§»é™¤å·²å®Œæˆçš„è®¡åˆ’æ­¥éª¤
        current_state.execution_plan.pop(0)
        return {"project_state": current_state}
